@using Application.Data.Models
@using Application.Web.Views.Components
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model PickYourAnimalViewModel
@{
    ViewData["Title"] = "Kies je beestje";
}

<component type="typeof(BookingStepper)" render-mode="ServerPrerendered" param-CurrentStep="2" />

<div class="uk-flex uk-flex-wrap-reverse gap-4">
    <form asp-action="SaveSelectedAnimals" method="post" class="uk-card uk-card-default uk-width-expand">
        <div class="uk-card-header flex uk-align-center uk-flex-between uk-flex-middle">
            <h1>
                Stap 2 - Kies je beestjes
                <button type="button" class="uk-icon-button" uk-tooltip="Bekijk regels" uk-toggle="target: #rules-modal">
                    <uk-icon icon="info" height="20" width="20" stroke-width="2"></uk-icon>
                </button>
            </h1>
            <button class="uk-button uk-button-primary" type="submit">Volgende stap</button>
        </div>
        <div class="uk-card-body" id="animalsFormBody">
            <div class="uk-flex uk-flex-wrap uk-flex-between -mb-4">
                @foreach (var animal in Model.Animals)
                {
                    <input type="checkbox" id="animal-@animal.Id" name="selectedAnimalIds" value="@animal.Id" class="uk-checkbox uk-hidden" @(!animal.IsAvailable ? "disabled" : "") />
                    <label class="uk-card uk-card-default !mb-4 checkbox-card @(animal.Type == AnimalType.Vip ? "checkbox-card--vip" : "")" for="animal-@animal.Id">
                        @if (animal.Type == AnimalType.Vip)
                        {
                            <div class="uk-position-top-left uk-position-z-index-high mt-1 ms-1" uk-tooltip="VIP">
                                <img src="/img/platinum-badge.png" height="48" width="48" alt="VIP" />
                            </div>
                        }
                        <uk-icon icon="calendar-x"
                                 uk-tooltip="Dit beestje is niet beschikbaar op deze datum"
                                 height="32" width="32" 
                                 class="disabled-icon uk-text-danger uk-position-top-right uk-position-z-index-high mt-2 me-2"></uk-icon>
                        <svg class="check-icon uk-position-top-right uk-position-z-index-high mt-2 me-2" width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22Z" fill="#4a6c14" stroke="#4a6c14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 12L11 14L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="uk-card-body">
                            <img src="@animal.Image" alt="@animal.Name" class="uk-height-small"/>
                            <div class="uk-flex uk-flex-between uk-align-center uk-text-large uk-margin-top">
                                <h3 class="uk-text-bolder">@animal.Name</h3>
                                <p class="uk-text-bold text-muted-foreground">&euro;@animal.Price</p>
                            </div>
                        </div>
                    </label>
                }
            </div>
        </div>
    </form>
    <div class="uk-width-1-4">
        <div class="uk-card uk-card-default" uk-sticky="offset: 25">
            <div class="uk-card-header uk-margin-bottom">
                <h2 class="uk-card-title">Overzicht boeking</h2>
            </div>
            <div class="uk-card-body">
                <div class="uk-margin-bottom">
                    <div class="uk-flex uk-flex-between">
                        <p class="uk-text-bold">Datum</p>
                        <a asp-controller="Home" asp-action="Index" class="uk-text-bold text-highlight uk-link-text">Aanpassen</a>
                    </div>
                    <p class="uk-text-muted">@Model.Date.ToShortDateString()</p>
                </div>
                <div class="uk-margin-bottom">
                    <p class="uk-text-bold">Beestjes</p>
                    <p class="uk-text-italic uk-text-muted">Selecteer je beestjes in de lijst</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="uk-flex-top" uk-modal id="rules-modal">
    <div class="uk-margin-auto-vertical uk-modal-dialog">
        <div class="uk-modal-header">
            <h2 class="uk-modal-title uk-text-bold">Keuze regels</h2>
        </div>
        <div class="uk-modal-body">
            <h3 class="uk-text-bold">Combinaties</h3>
            <ul class="uk-list uk-list-disc uk-margin-bottom">
                <li uk-tooltip="Nom nom nom">Je mag geen beestje boeken met het type ‘Leeuw’ of ‘IJsbeer’ als je ook een beestje boekt van het type ‘Boerderijdier</li>
            </ul>
            <h3 class="uk-text-bold">Tijds- en seizoensgebonden</h3>
            <ul class="uk-list uk-list-disc uk-margin-bottom">
                <li uk-tooltip="Dieren in pak werken alleen doordeweeks">Je mag geen beestje boeken met de naam ‘Pinguïn’ in het weekend</li>
                <li uk-tooltip="Brrrr – Veelste koud">Je mag geen beestje boeken van het type ‘Woestijn’ in de maanden oktober t/m februari</li>
                <li uk-tooltip="Some People Are Worth Melting For. ~ Olaf">Je mag geen beestje boeken van het type ‘Sneeuw’ in de maanden juni t/m augustus</li>
            </ul>
            <h3 class="uk-text-bold">
                Klantenkaarten
            </h3>
            <ul class="uk-list uk-list-disc">
                <li>Klanten zonder klantenkaart mogen maximaal 3 dieren boeken</li>
                <li>Klanten met een zilveren klantenkaart mogen 1 dier extra boeken</li>
                <li>Klanten met een gouden kaart mogen zoveel dieren boeken als ze willen</li>
                <li>Klanten met een platina kaart mogen daarnaast ook nog de VIP dieren boeken.</li>
            </ul>
        </div>
        <div class="uk-modal-footer uk-text-right">
            <button class="uk-button uk-button-default uk-modal-close" type="button">Sluiten</button>
        </div>
    </div>
</div>

@{
    var customerCard = Model.CustomerCard switch
    {
        CustomerCardType.Silver => CustomerCardType.Silver.ToString(),
        CustomerCardType.Gold => CustomerCardType.Gold.ToString(),
        CustomerCardType.Platinum => CustomerCardType.Platinum.ToString(),
        _ => "null"
    };
}

@section Scripts {
    <script>
        // Create the alert element
        const alert = document.createElement('div');
        alert.className = 'uk-alert uk-alert-danger bg-white/[0.4] uk-margin-bottom uk-position-bottom-center uk-position-fixed z-[1000] backdrop-blur-lg';
        alert.setAttribute('uk-alert', '');
        alert.innerHTML = `<a href class="uk-alert-close"></a><div class="uk-alert-title">Het is niet mogelijk om dit beestje te selecteren. Zie de regels (i)</div>`; 
    
        document.querySelectorAll('input[name="selectedAnimalIds"]').forEach(input => {
            input.addEventListener('click', (event) => {
                alert.remove();
                if (!event.target.checked) return;
                
                event.preventDefault();
                document.body.classList.add('loading');
    
                const selectedAnimalIds = Array.from(document.querySelectorAll('input[name="selectedAnimalIds"]:checked')).map(input => input.value);
    
                fetch('/booking/validate-animal-selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        animalToAddId: parseInt(event.target.value),
                        selectedAnimalIds: selectedAnimalIds.map(id => parseInt(id)),
                        date: "@Model.Date.ToString("yyyy-MM-dd")",
                        customerCard: @customerCard
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.isValid) {
                            alert.innerHTML = 
                                `<a href class="uk-alert-close"></a>
                                <div class="uk-alert-title">Het is niet mogelijk om dit beestje te selecteren. 
                                    <button type="button" uk-toggle="target: #rules-modal"><uk-icon class="uk-display-inline-block" icon="info"></uk-icon></button>
                                </div>
                                <div class="uk-alert-description">${data.errorMessage}</div>`;
                            document.body.prepend(alert);                            
                            event.target.checked = false;
                        } else {
                            event.target.checked = true;
                        }
                    })
                    .catch(() => {
                        alert.innerHTML = `<div class="uk-alert-title">Er is iets misgegaan. Probeer het later opnieuw.</div>`;
                        document.body.prepend(alert);
                        event.target.checked = false;
                    })
                    .finally(() => document.body.classList.remove('loading'));
            });
        });
    </script>
}